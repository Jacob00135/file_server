[TOC]

# 开发文档

## 1.准备工作

### 1.1需求

1. 身份权限功能：两种身份：**管理员**，**游客**。管理员可以设置游客能做什么操作，不能做什么操作。
2. 文件操作：管理员指定的目录，该目录内文件可以被查看、下载、重命名、删除，也可以上传新文件。
3. 移动端优先

### 1.2项目结构

```text
├─blueprints
│  ├─identity.py  # 实现身份权限功能
│  ├─main.py  # 实现文件操作功能
├─database_sqlite  # 存放SQLite数据
├─static  # 存放css、js、scss
├─templates  # 存放html
├─tests  # 单元测试
├─__init__.py  # 初始化应用
├─config.py  # 项目配置文件
├─models.py  # 数据库模型
├─app.py  # 应用启动文件
├─requirements.txt  # 项目运行需求文件
├─开发文档.md
```

### 1.3选用技术

Python版本3.9.12

1. 前端：Bootstrap3
2. 后端：Flask
3. 数据库：SQLSite

## 2.项目配置

### 2.1编写配置文件

配置文件中需要配置：

1. 应用参数、变量
2. 数据库配置

### 2.2创建应用的函数、配置启动参数

工厂函数的工作：

1. 生成应用
2. 配置Flask扩展
3. 注册蓝图
4. 创建数据库、建表

### 2.3应用配置的单元测试

1. 开启应用的测试模式
2. 编写单元测试基类
3. 编写配置应用的单元测试，检查：
    1. 应用是否能被工厂函数创建
    2. 应用是否已开启测试模式
    3. 数据库、表是否被创建，是否已插入管理员记录

### 2.4前端配置

1. 准备Bootstrap的CSS、JavaScript、fonts文件
2. 创建base.html模板

## 3.应用初步功能

### 3.1编写错误页面

1. 编写404.html、500.html、403.html来展示最常见的三种状态码异常页面
2. 对每个页面进行单元测试

### 3.2管理员登录、登出

1. 编写Customer模型，包含字段：customer_id，customer_name，password_hash
2. 在Customer模型中，添加Flask-Login扩展所需的属性和方法，添加生成password_hash的方法
3. 为Flask-Login添加load_user函数
4. 编写导航栏，包含链接：主页、登录，以及登录后才显示的管理链接
5. 编写登录页面、登录路由、登出路由
6. 工厂函数在创建应用时，在customers表中插入一条管理员身份记录，账户名默认为admin，密码默认为123456

customers建表语句：

```sqlite
CREATE TABLE IF NOT EXISTS customers
(
    customer_id   INTEGER PRIMARY KEY AUTOINCREMENT,
    customer_name VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(128) NOT NULL
);
```

单元测试内容：

1. 未登录用户访问登录页面，显示登录页面
2. 已登录用户访问登录页面，重定向到主页
3. 登录请求：用户名为空
4. 登录请求：密码为空
5. 登录请求：用户名不存在
6. 登录请求：密码错误
7. 登录请求：登录成功
8. 未登录用户访问登出页面，直接重定向到主页
9. 已登录用户访问登出页面，登出然后重定向到主页
10. Customer模型自动生成password_hash的测试
11. verify_password方法的测试

### 3.3管理员修改密码

1. 在导航栏的管理按钮下拉菜单中，添加“修改密码”按钮
2. 点击“修改密码”按钮，弹出模态框，输出两次密码才能提交，密码不一致时使用警告框警告
3. 异步提交form表单

单元测试内容：

1. 未登录用户请求修改密码：403
2. 修改密码请求：密码位数不在[6, 20]
3. 修改密码请求：新旧密码一样
4. 修改密码请求：修改成功

## 4.管理可见目录

### 4.1添加可见目录

1. 把导航栏的管理按钮改成下拉菜单，菜单中有“可见目录”链接
2. 在可见目录页面中，可以添加、删除可见目录，还可以设置不同身份对目录的访问权限
3. 对于添加目录的操作，需要：
    1. 在数据库中建表directory，包含字段：dir_id，dir_path，access
    2. 在工厂函数中，初始化数据库时，建表directory
    3. access字段表示查看一个目录需要多少权限，可选：1、2、4，不同身份的权限值：游客1，管理员7
4. 注意：项目所在目录不能被添加

directory建表指令：

```sqlite
CREATE TABLE IF NOT EXISTS directory
(
    dir_id   INTEGER PRIMARY KEY AUTOINCREMENT,
    dir_path TEXT    NOT NULL UNIQUE,
    access   INTEGER NOT NULL
);
```

单元测试内容：

1. 未登录用户访问可见目录页面，403
2. 已登录用户访问可见目录页面，200
3. 未登录用户请求添加目录：403
4. 添加目录请求：路径不存在
5. 添加目录请求：目录路径已添加过
6. 添加目录请求：访问权限不合法
7. 添加目录请求：添加成功，检查数据库是否已经添加目录路径
8. 检查Directory模型的can方法：access=1的目录游客和管理员都有权限，access=4的目录游客无权限，管理员有权限
9. 检查Directory模型的admin_level方法：access=1的目录和access=4的目录管理员都有权限

### 4.2删除可见目录

1. 可见目录页添加“删除”按钮，点击事件：显示每一条可见目录的选择单选框、全选框、反选框
2. 异步提交删除可见目录的请求

单元测试内容：

1. 未登录用户请求删除目录：403
2. 删除目录请求：json解析失败
3. 删除目录请求：成功
4. 删除目录请求：包含没有添加的目录

### 4.3更改可见目录查看权限

1. 在可见目录页添加“更改权限”按钮，点击后每个条目右侧出现可选权限下拉菜单，按钮组添加“确定修改”按钮
2. 在js中只保存被更改过的条目，使用AJAX发送到服务器

单元测试内容：

1. 未登录用户请求更改权限：403
2. 更改权限请求：json解析失败
3. 更改权限请求：成功
4. 更改权限请求：条目中不包含需要的键
5. 更改权限请求：路径的值没有添加过
6. 更改权限请求：权限值不合法

## 5.文件管理核心功能的规划

需要在主页中显示每个文件条目，并显示：

1. 文件图标。区分目录、文本、图片、音频、视频、压缩包、其他
2. 文件名。太长时用省略号结尾
3. 文件大小。
4. 操作下拉菜单。包含下载、重命名、删除、移动、复制
5. 在文件查看器的上方，显示上传按钮
6. 文本、图片、音频、视频文件可以在线查看

## 6.查看文件功能

### 6.1路由中的文件路径规则

1. 主页```'/'```：显示所有**可见目录**，可见目录在数据库中拿取，后端响应到前端时，会检查当前用户是否已经登录，若已经登录则响应所有可见目录，否则只响应access=1的可见目录
2. 可见目录页```'/<可见目录路径>'```：根据路由中的可见目录路径，查询数据库中的可见目录，若查询不到则响应404，否则响应该可见目录中所有文件
3. 可见目录内的文件页面```/<可见目录路径>?path=<文件相对于可见目录的路径>```：拼接路由中的路径成为完整路径，然后检查文件是否存在并响应

例子：

假设数据库中的directory表的记录有：

| dir_path | access |
|:------:|:------:|
|c:\\|1|
|d:\\workspace|4|

- 访问```'/'```时：```c:\\```向游客和管理员显示，```d:\\workspace```向管理员显示
- 访问```'/c:\\'```时，显示c:\\下的所有文件；访问```d:\\workspace```时，显示d:\\workspace下的所有文件
- 若想要查看c:\\users，需要访问：```'/c:\\?path=users'```；若想要查看d:\\workspace\\my_project\\flasky，需要访问：```'/d:\\workspace?path=my_project\\flasky'```

### 6.2文件条目对象

在后端需要把多个文件条目放入列表响应给前端，为了方便传输，创建一个```FileItem```类，用FileItem对象来代表一个文件

```FileItem```类应该包含的属性：

- 文件路径。必须全小写、字母开头、```'/'```替换成```'\\'```、不以```'\\'```结尾
- 文件类型。可以是dir、text、image、audio、video、package、other
- 文件名、文件大小

```FileItem```类实例化时，只需传入文件的路径，就可以生成实例变量，这些操作由实例方法```init_file```来完成。该方法需要做：

1. 把传入的路径标准化处理：全小写、检查字母开头、```'/'```替换成```'\\'```、经过```os.path.abspath()```处理
2. 检查路径是否存在
3. 使用os.path.isdir判断文件类型是否是dir，使用```filetype```和```mimetypes```库判断非目录文件类型
4. 使用os.path.basename获取文件名，使用os.path.getsize获取文件大小（字节）并封装函数来对文件大小进行格式化（使用B、KB、MB、GB、TB来显示文件大小）
5. 对于实例化失败（例如路径不存在）的文件，抛出```OSError```。

在```FileItem```类中还有```get_file_type```方法和```get_file_size```方法，分别用于获取文件的类型和文件大小

### 6.3展示一个目录内的所有直属子目录和直属文件

当用户访问一个目录的页面时，后端需要向前端响应此目录中所有的直属子目录和直属文件，操作步骤如下：

1. 使用```os.listdir```获取所有直属子目录和直属文件
2. 把所有直属子目录和直属文件以FileItem对象的方式放入列表，响应到前端页面

而前端需要把这些目录或文件展示出来，需要遍历FileItem对象，对于每一个FileItem对象，进行的操作：

1. 建立一个文件类型和字体图标CSS类的映射表，使得dir、text、image、audio、video、package、other类型有不同的字体图标，以表示不同的文件类型
2. 以链接形式显示文件名，文件是目录时，链接到目录查看页面，否则，链接到文件打开页面（只支持text、audio、image、video在线预览）
3. 显示文件的大小
4. 在每个文件条目的最右边显示一个小型的三点符号按钮式下拉菜单，表示对文件的操作，下拉菜单条目包括下载、完整文件名、重命名、复制、移动、删除（按此顺序罗列），其中，只有下载、完整文件名是游客有权限使用，其他功能只有管理员有权限使用